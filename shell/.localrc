###################################################################################
# Functions
###################################################################################
killport() {
	kill -9 $(lsof -ti:$@)
}

count(){
	ls $@ -1 | wc -l
}

gitExclude() {
	echo $@ >> ~/.git/info/exclude
}

###################################################################################
# Theme Switcher
###################################################################################
theme() {
    if [ -z "$1" ]; then
        local current=$(cat ~/.dotfiles/themes/current-theme 2>/dev/null || echo "unknown")
        echo "Current theme: $current"
        echo ""
        echo "Available themes:"
        ls ~/.dotfiles/themes/*.lua 2>/dev/null | xargs -n 1 basename | sed 's/.lua$//' | sed 's/^/  - /'
        echo ""
        echo "Usage: theme <theme-name>"
        return 0
    fi

    local theme_name="$1"
    local theme_file="$HOME/.dotfiles/themes/${theme_name}.lua"

    if [ ! -f "$theme_file" ]; then
        echo "‚ùå Theme '$theme_name' not found"
        echo "Available themes:"
        ls ~/.dotfiles/themes/*.lua 2>/dev/null | xargs -n 1 basename | sed 's/.lua$//' | sed 's/^/  - /'
        return 1
    fi

    echo "$theme_name" > ~/.dotfiles/themes/current-theme

    # Reload tmux if running
    if command -v tmux &> /dev/null && tmux info &> /dev/null 2>&1; then
        # Reload config for current session
        tmux source-file ~/.tmux.conf 2>/dev/null
        # Run the theme loader directly to ensure colors apply
        ~/.dotfiles/themes/load-tmux-theme.sh 2>/dev/null
        echo "‚úÖ tmux theme reloaded"
    fi

    echo "‚úÖ Theme switched to: $theme_name"
    echo "üí° Restart Neovim to apply changes"
}

###################################################################################
# TMUX
###################################################################################
ts() {
    local session_name
    if [ $# -gt 0 ]; then
        session_name="$1"
    else
        session_name=$(basename "$PWD" | sed 's/[^a-zA-Z0-9_-]/_/g')
         if [ -z "$session_name" ]; then
             session_name="default"
         fi
    fi

    if ! command -v tmux &> /dev/null; then
        echo "Error: tmux command not found."
        return 1
    fi

    # Check if running inside a tmux session
    if [ -n "$TMUX" ]; then
        if tmux has-session -t "$session_name" 2>/dev/null; then
            # Session exists, switch the client to it
            local current_session=$(tmux display-message -p '#S')
            if [ "$current_session" != "$session_name" ]; then
                 echo "Switching client to session: $session_name"
                 tmux switch-client -t "$session_name"
            else
                 echo "Already attached to session: $session_name"
            fi
        else
            # Session does not exist - Instruct user to exit first
            echo "Session '$session_name' does not exist."
            echo "To create a new session, please detach from your current tmux session first."
            return 1
        fi
    else
        # --- Running Outside Tmux ---
        if tmux has-session -t "$session_name" 2>/dev/null; then
            # Session exists, attach to it
            echo "Attaching to existing tmux session: $session_name"
            tmux attach-session -t "$session_name"
        else
            # Session does not exist, create it and attach
            echo "Creating new session '$session_name' with VIM and server windows..."
            tmux new-session -d -s "$session_name" -n "VIM" "nvim ."
            tmux new-window -t "$session_name" -n "server"
            tmux new-window -t "$session_name" -n "claude"
            tmux select-window -t "$session_name:1"
            tmux attach-session -t "$session_name"
        fi
    fi
}

ta(){
  tmux attach-session -t $@
}

tk(){
  tmux kill-session -t  $@
}

tl(){
  tmux ls
}

###################################################################################
# Docker
###################################################################################
alias d='docker'
alias dc='docker compose'
alias drm='docker rm $(docker ps --all --quiet)'
alias drmi='docker rmi $(docker images --quiet --filter "dangling=true")'


###################################################################################
# Git
###################################################################################
alias got='git'
alias pull='git pull'
alias fetch='git fetch'
alias checkout='git checkout'
alias branch='git branch'
push(){
   git push --set-upstream origin $1
}

remote_checkout(){
  fetch
  git checkout -b $1 origin/$1
}

#####################################################################################
#Aliases
#####################################################################################
alias vim='nvim'
alias v='nvim'
alias mv='mv -i'
alias clc='clear'
alias cls='clear'
alias clera='clear'
alias celar='clear'
alias ckear='clear'
alias ckear='clear'
alias ipconfig='ifconfig'
alias cat='bat'
alias dot='cd ~/.dotfiles'
alias grep='rg'
alias find='fd'
alias lt='du -sh * | sort -h'
alias loads='cd ~/loads'
alias src='source ~/.zshrc'
alias diff='nvim -d'
alias dif='diff'
alias pretty="jq '.'"

#####################################################################################
#RUST
#####################################################################################
. "$HOME/.cargo/env"

##############################################
#######################################
#Python
#####################################################################################
alias python='python3'
alias pip='pip3'
alias py='python'
alias py-env="source .venv/bin/activate"

#####################################################################################
#Include Scripts to Path and Custom Functions
#####################################################################################
export PATH="$PATH:/usr/local/go/src"

#####################################################################################
# Node Version Manager
#####################################################################################
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

#####################################################################################
# Go
#####################################################################################
export PATH="$PATH:/Users/TaylorGuevarez/go/bin";

#####################################################################################
# Scripts
#####################################################################################
export PATH="$PATH:/Users/TaylorGuevarez/scripts";

#####################################################################################
# Notes
#####################################################################################
note () {
  \nvim ~/notes/$(date '+%Y-%m-%d').md
}
alias notes='note'

# Add a blank line after ps1
precmd() { print "" }


softReset() {
  if [ -z "$1" ]; then
    echo "‚ùå Usage: squash_and_rebase <branch>"
    return 1
  fi

  local target_branch=$1

  # make sure we have the latest refs
  git fetch origin

  # find the common ancestor between current branch and target
  local base
  base=$(git merge-base HEAD origin/$target_branch) || return 1

  # squash all commits into one (keeps changes staged)
  git reset --soft "$base" || return 1
}

#####################################################################################
# Notes
#####################################################################################
work-tree() {
  if [ -z "$1" ]; then
    echo "Error: Please provide a feature name"
    echo "Usage: create-feature <feature-name>"
    return 1
  fi

  local feature_name="$1"
  local branch_name="feature/${feature_name}"
  local repo_name=$(basename "$(git rev-parse --show-toplevel 2>/dev/null || echo "$PWD")")
  local worktree_dir="../${repo_name}-${feature_name}"

  echo "Creating worktree for ${branch_name}..."
  git worktree add "${worktree_dir}" -b "${branch_name}" develop

  if [ $? -eq 0 ]; then
    echo "Linking node_modules..."
    cd "${worktree_dir}"
    ln -s ../${repo_name}-develop/node_modules node_modules
    echo "‚úÖ Feature worktree created at ${worktree_dir}"
    echo "üì¶ node_modules linked to ${repo_name}-develop"
    echo ""
    echo "To start working: cd ${worktree_dir}"
  else
    echo "‚ùå Failed to create worktree"
    return 1
  fi
}
alias worktree='work-tree'

source ~/.shift4rc

